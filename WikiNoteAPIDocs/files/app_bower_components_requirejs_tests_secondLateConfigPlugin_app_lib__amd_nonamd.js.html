<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/bower_components/requirejs/tests/secondLateConfigPlugin/app/lib_/amd/nonamd.js - WikiNote API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.8.0pr2/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <script src="http://yui.yahooapis.com/combo?3.8.0pr2/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            <h1><a href="../index.html"><img src="../assets/css/logo.png" width="117" height="52">WikiNote API: app/bower_components/requirejs/tests/secondLateConfigPlugin/app/lib_/amd/nonamd.js</a></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div class="yui3-g">

        <div id="sidebar" class="yui3-u">
            <div id="modules" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Modules</h2>
                </div>
                <div class="bd">
                    <ul>
                    </ul>
                </div>
            </div>
            
            <div id="classes" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Classes</h2>
                </div>
                <div class="bd">
                    <ul>
                            <li><a href="../classes/data.html">data</a></li>
                    </ul>
                </div>
            </div>
            
            
            
            
            
            <div id="fileTree" class="sidebox">
                <div class="hd">
                    <h2 class="no-toc">Files</h2>
                </div>
                <div class="bd">
                    <ul><li>app/<ul><li>bower_components/<ul><li>jquery/<ul><li>dist/<ul><li><a href="../files/app_bower_components_jquery_dist_jquery.js.html">jquery.js</a></li></ul></li><li>src/<ul><li>ajax/<ul><li><a href="../files/app_bower_components_jquery_src_ajax_load.js.html">load.js</a></li></ul></li><li>core/<ul><li><a href="../files/app_bower_components_jquery_src_core_ready.js.html">ready.js</a></li></ul></li><li>css/<ul><li><a href="../files/app_bower_components_jquery_src_css_defaultDisplay.js.html">defaultDisplay.js</a></li></ul></li><li>data/<ul><li><a href="../files/app_bower_components_jquery_src_data_accepts.js.html">accepts.js</a></li></ul></li><li><a href="../files/app_bower_components_jquery_src_offset.js.html">offset.js</a></li><li>sizzle/<ul><li>dist/<ul><li><a href="../files/app_bower_components_jquery_src_sizzle_dist_sizzle.js.html">sizzle.js</a></li></ul></li></ul></li></ul></li></ul></li><li>marked/<ul><li>lib/<ul><li><a href="../files/app_bower_components_marked_lib_marked.js.html">marked.js</a></li></ul></li><li><a href="../files/app_bower_components_marked_marked.min.js.html">marked.min.js</a></li></ul></li><li>requirejs/<ul><li>dist/<ul><li><a href="../files/app_bower_components_requirejs_dist_dist-site.js.html">dist-site.js</a></li><li><a href="../files/app_bower_components_requirejs_dist_file.js.html">file.js</a></li></ul></li><li><a href="../files/app_bower_components_requirejs_require.js.html">require.js</a></li><li>tests/<ul><li>circular/<ul><li>complexPlugin/<ul><li><a href="../files/app_bower_components_requirejs_tests_circular_complexPlugin_slowText.js.html">slowText.js</a></li></ul></li></ul></li><li>jquery/<ul><li>scripts/<ul><li><a href="../files/app_bower_components_requirejs_tests_jquery_scripts_jquery-1.7.1.js.html">jquery-1.7.1.js</a></li></ul></li></ul></li><li>secondLateConfigPlugin/<ul><li>app/<ul><li>lib_/<ul><li>amd/<ul><li><a href="../files/app_bower_components_requirejs_tests_secondLateConfigPlugin_app_lib__amd_nonamd.js.html">nonamd.js</a></li><li><a href="../files/app_bower_components_requirejs_tests_secondLateConfigPlugin_app_lib__amd_text.js.html">text.js</a></li></ul></li></ul></li></ul></li></ul></li><li>text/<ul><li><a href="../files/app_bower_components_requirejs_tests_text_textBuilt.js.html">textBuilt.js</a></li></ul></li></ul></li></ul></li></ul></li><li>script/<ul><li><a href="../files/app_script_data.js.html">data.js</a></li></ul></li><li>src/<ul><li><a href="../files/app_src_data.js.html">data.js</a></li></ul></li></ul></li></ul>
                </div>
            </div>
            
        </div>

        <div id="main" class="yui3-u">
            <div class="content"><h4>app/bower_components/requirejs/tests/secondLateConfigPlugin/app/lib_/amd/nonamd.js</h4>

<pre class="code prettyprint linenums">
/*!
 * Copyright 2002 - 2015 Webdetails, a Pentaho company.  All rights reserved.
 *
 * This software was developed by Webdetails and is provided under the terms
 * of the Mozilla Public License, Version 2.0, or any later version. You may not use
 * this file except in compliance with the license. If you need a copy of the license,
 * please go to  http://mozilla.org/MPL/2.0/. The Initial Developer is Webdetails.
 *
 * Software distributed under the Mozilla Public License is distributed on an &quot;AS IS&quot;
 * basis, WITHOUT WARRANTY OF ANY KIND, either express or  implied. Please refer to
 * the license for the specific language governing your rights and limitations.
 */

/**
 * AMD loader plugin that wraps non-amd scripts as amd modules on the fly.
 * Depends on the standard text! plugin, registered under the module id &quot;text&quot;.
 * 
 * Wrapping is the only 100% safe method of ensuring that 
 * a non-amd module that depends on another non-amd module
 * uses the right version of the latter.
 * 
 * The following description shows how it is possible to load an 
 * incorrect version of a dependency if the _native_ shim is used:
 * 
 * 1. A first module, A, is required.
 * 2. Module A depends on the non-amd module, J1.
 * 3. Module J1 is not yet loaded.
 * 4. Module J1 is then loaded and publishes its value in global variable &#x60;J&#x60; and the loader
 *    reads this value correctly, according to an &#x60;exports: &quot;J&quot;&#x60; configuration.
 * 5. Module A is loaded and correctly reads the global value exported by module J1, in variable &quot;J&quot;.
 * 6. A second module, B, is required.
 * 7. Module B depends on another non-amd module, J2.
 * 8. Module J2 is not yet loaded.
 * 9. Module J2 is then loaded and **also** publishes its value in global variable &#x60;J&#x60; and the loader
 *    reads this value correctly, according to an &#x60;exports: &quot;J&quot;&#x60; configuration.
 * 10. Module B is loaded and correctly reads the global value exported by module J2, in variable &quot;J&quot;.
 * 11. A third module, C, is required.
 * 12. Module C depends on the non-amd module, J1.
 * 13. Module J1 is **already** loaded.
 * 14. Module C is then loaded and **incorrectly** reads the global value exported by module J2, 
 *     in variable &quot;J&quot;, and not that exported by module J1.
 * 
 * In any case, J1 or J2, the AMD loader correctly reads the just published value, 
 * and so real AMD modules depending on these always receive the correct value.
 * 
 * The conclusion is that to be 100% safe,
 * any code depending on non-amd modules 
 * **must** be an amd module!
 * 
 * This plugin makes it easy to turn non-amd modules into amd modules.
 * The downfall is that all modules that depend on non-amd modules 
 * need to use its _special_ module id:
 * 
 * &#x60;&#x60;&#x60;javascript
 * define([&#x27;amd!jquery.ui&#x27;], function($) {
 *    // jquery ui has been loaded, and in the configured jquery instance, for sure, really, really!
 * });
 * &#x60;&#x60;&#x60;
 * 
 * The configuration of a module for use with this plugin is as close
 * as possible to a _native_ shim configuration:
 * 
 * &#x60;&#x60;&#x60;javascript
 * requirejs.config({
 *   paths: {
 *     &quot;amd&quot;: &quot;path to the non-amd plugin&quot; 
 *   },
 *   
 *   config: {
 *     // non-amd plugin configuration section
 *     &quot;amd&quot;: {
 *       shim: {
 *         &quot;jquery.ui&quot;: {
 *            exports: &quot;$&quot;, // re-exports jquery
 *            deps: { // instead of just an array, an object allows defining the define function argument names
 *              &quot;$&quot;: &quot;the-module-id-of-the-jquery-I-want&quot;
 *              // other dependencies
 *            }
 *         }
 *       }
 *     }
 *   }
 * });
 * &#x60;&#x60;&#x60;
 */

define([&quot;module&quot;, &quot;text&quot;], function(module, text) {
  
  var mainConfig = module.config(), // non-amd plugin&#x27;s own config
      rBuildModuleText = {}; // only used in r.js environment.
  
  return {
    load: function(moduleId, parentRequire, onLoad, config) {

      var moduleUrl    = parentRequire.toUrl(moduleId + &quot;.js&quot;),
          moduleConfig = (mainConfig.shim &amp;&amp; mainConfig.shim[moduleId]) || {};
      
      moduleConfig.id  = moduleId;
      moduleConfig.url = moduleUrl;
      
      text.get(moduleUrl, function onLoadSuccess(jsText) {
          
          jsText = compileNonAmd(jsText, moduleConfig, config.isBuild);
          
          if(config.isBuild) rBuildModuleText[moduleId] = jsText;
          
          onLoad.fromText(jsText);
          
        }, onLoad.error);
    },
     
    // Build time, r.js support
    write: function() {
       // TODO
    }
  };
   
  // == COMPILER ==
  
  /**
   * Compiles a non-amd module given its non-amd code and its compilation configuration options.
   * @param {string} jsText The non-amd JavaScript code.
   * @param {object} moduleConfig The non-amd configuration of the module being compiled.
   * @param {string} moduleConfig.id The amd id of the module being compiled.
   * @param {string} moduleConfig.url The url from which the &#x60;jsText&#x60; was loaded from.
   * @param {string} [moduleConfig.prescript] Arbitrary JavaScript code placed at 
   *    the first line of the module&#x27;s define function.
   * @param {string} [moduleConfig.postscript] Arbitrary JavaScript code placed at 
   *    the end of the module&#x27;s define function.
   *    Placed before the return code generated when &#x60;exports&#x60; is also specified.
   *    If this option already contains a return statement, don&#x27;t specify the &#x60;exports&#x60; option.
   * @param {string} [moduleConfig.exports] The name of a variable that the module exports.
   *    When unspecified, the module value must instead be returned by the 
   *    code in the more general &#x60;postscript&#x60; option.
   * @param {Object.&lt;string, string&gt;} [moduleConfig.deps] A map of dependencies of the module, 
   *    having as keys the module&#x27;s define function argument names and as values the correposding module ids.
   * @param {boolean} [isBuild=false] Whether running in build mode, under r.js.
   */
  function compileNonAmd(jsText, moduleConfig, isBuild) {
    var moduleUrl = moduleConfig.url, // required
        exports   = moduleConfig.exports,
        prescript = moduleConfig.prescript,
        postscript = moduleConfig.postscript;
    
    jsText = &#x27;define(&#x27; + compileHeader(moduleConfig) + 
             &#x27;  var define = undefined;\n&#x27; + // Avoid &#x27;define&#x27; detection and self registration
             (prescript ? (&#x27;  &#x27; + prescript + &#x27;\n&#x27;): &#x27;&#x27;) +
             jsText + &#x27;\n&#x27; +
             (postscript ? (&#x27;  &#x27; + postscript +       &#x27;\n&#x27;) : &#x27;&#x27;) +
             (exports   ? (&#x27;  return &#x27; + exports + &#x27;;\n&#x27;) : &#x27;&#x27;) + 
             &#x27;});&#x27;;
    
    // IE with conditional comments on cannot handle the
    // sourceURL trick, so skip it if enabled.
    /*@if (@_jscript) @else @*/
    if(!isBuild) {
      if(typeof document !== &quot;undefined&quot; &amp;&amp; moduleUrl.charAt(0) === &#x27;/&#x27;)
        moduleUrl = document.location.protocol + &quot;//&quot; + document.location.host + moduleUrl;
         
      jsText += &#x27;\n//# sourceURL=&#x27; + moduleUrl;
    }
    /*@end@*/
    
    return jsText;
  }
  
  // The text following &quot;define(&quot;, until the opening brace, inclusive.
  function compileHeader(moduleConfig) {
    var moduleToArgMap = moduleConfig.deps;
    if(moduleToArgMap) {
      var depModuleIds = [], depArgNames= [], depModuleIdsFinal = [];
      for(var moduleId in moduleToArgMap) {
        if(moduleToArgMap.hasOwnProperty(moduleId)) {
          var argName = moduleToArgMap[moduleId];
          if(argName) {
            depArgNames.push(argName);
            depModuleIds.push(moduleId);
          } else {
            depModuleIdsFinal.push(moduleId);
          }
        }
      }
      for(var i = 0; i &lt; depModuleIdsFinal.length; i++) {
        depModuleIds.push(depModuleIdsFinal[i]);
      }
      
      // Something like: 
      //  [&quot;foo/bar&quot;, &quot;gugu/dada&quot;], function(bar, dada) {\n
      if(depModuleIds.length)
        return &#x27;[&quot;&#x27; + depModuleIds.join(&#x27;&quot;, &quot;&#x27;) + &#x27;&quot;], function(&#x27; + depArgNames.join(&#x27;, &#x27;)  + &#x27;) {\n&#x27;;
    }
    
    return &#x27;function() {\n&#x27;;
  }
});

</pre>

</div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/js/tabs.js"></script>
</body>
</html>
